@* Zweck: Chat-Eingabe *@
@page "/"

<div class="chat-area">
    <!-- Nachrichten oben; Abstand nach unten entsteht durch Position der Eingabebox -->
    <div class="messages">
        @foreach (var m in messages)
        {
            <div class="msg">@m</div>
        }
    </div>
    <!-- Eingabebox: responsive Start-/Zielposition statt cm -->
    <!-- POSITION: Werte in clamp() anpassen für Start/Zielhöhe -->
    <div class="chat-input-wrapper" style="@($"top:{(moved ? "clamp(350px,50vh,480px)" : "clamp(150px,25vh,280px)")}")">
        <textarea id="chatInput"
                  class="chat-input"
                  placeholder="Nachricht eingeben..."
                  @bind="currentText"
                  @bind:event="oninput"
                  @onkeydown="HandleKeyDown"></textarea>
    </div>
</div>

@code {
    private List<string> messages = new();          // Nachrichtenliste
    private string? currentText;                    // Aktueller Eingabetext
    private bool moved = false;                     // Umschalten Start/Zielposition

    private void HandleKeyDown(KeyboardEventArgs e) // Tastendruck prüfen
    {
        if (e.Key == "Enter")                       // Enter löst Senden aus
        {
            Send();
        }
    }

    private void Send()                            // Nachricht senden
    {
        var txt = currentText?.Trim();             // Trim für sauberen Text
        if (string.IsNullOrEmpty(txt)) return;     // Leer -> Abbruch
        messages.Add(txt);                         // Liste erweitern
        if (!moved) moved = true;                  // Erste Nachricht -> Position ändern
        currentText = string.Empty;                // Eingabe zurücksetzen
        StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await JS.InvokeVoidAsync("resizeTextarea", "chatInput"); // Textarea anpassen (Höhe)
    }

    [Inject] private IJSRuntime JS { get; set; } = default!; // JS-Interop
}

<script>
    window.resizeTextarea = function(id){
        const ta = document.getElementById(id);
        if(!ta) return;
        const maxH = 240; // Max-Höhe vor Scrollbar
        const minH = 50;  // Min-Höhe Basis
        ta.style.height = 'auto';
        let needed = ta.scrollHeight;
        if (needed > maxH) needed = maxH;
        ta.style.height = needed + 'px';
        const grow = Math.max(0, needed - minH); // Differenz für nach-oben-Verschiebung
        const wrapper = ta.closest('.chat-input-wrapper');
        if(wrapper){
            wrapper.style.setProperty('--grow-offset', grow + 'px'); // OFFSET: Wachstum nach oben
        }
    };
    // Eingabe -> Höhe neu berechnen
    document.addEventListener('input', (e)=>{
        if(e.target && e.target.id === 'chatInput'){
            window.resizeTextarea('chatInput');
        }
    });
    // Enter verhindert Zeilenumbruch
    document.addEventListener('keydown', (e)=>{
        if(e.target && e.target.id === 'chatInput' && e.key === 'Enter'){
            e.preventDefault();
        }
    });
</script>

<style>
    .chat-area {
        max-width: 800px;
        margin: 0 auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem; /* Abstand Elemente */
        position: relative;
        box-sizing: border-box;
        min-height: 100%;
        padding-bottom: 300px; /* Reserve unten bei großer Eingabe */
    }

    .messages {
        display: flex;
        flex-direction: column;
        gap: 0.5rem; /* Abstand Nachrichten */
        width: 100%;
        align-items: flex-end;
        box-sizing: border-box;
    }

    .msg {
        background: rgba(255,255,255,0.08);
        padding: 0.5rem 0.75rem;
        border-radius: 12px;
        white-space: pre-wrap;
        display: inline-block;
        max-width: 75%; /* max Breite Nachricht */
        width: fit-content;
        word-break: break-word; /* Zeilenumbruch innerhalb Worte */
        margin-right: 0;
        box-sizing: border-box;
        text-align: left;
        font-size: 20px; /* Schriftgröße Nachrichten */
    }

    .chat-input-wrapper {
        --grow-offset: 0px; /* Dynamisch: durch JS gesetzt */
        width: 100%;
        border-radius: 14px;
        background: rgba(255,255,255,0.06);
        border: 1px solid rgba(255,255,255,0.25);
        box-sizing: border-box;
        position: absolute;
        left: 0;
        right: 0;
        padding: 0 0.6rem 0 0;
        overflow: visible; /* erlaubt Wachstum nach oben */
        z-index: 1;
        transition: top 0.6s ease; /* Animation Positionswechsel */
        transform: translateY(calc(-1 * var(--grow-offset))); /* Nach-oben-Verschiebung */
    }

    textarea.chat-input {
        display: block;
        width: 100%;
        min-height: 50px; /* Min-Höhe Eingabe (JS minH) */
        max-height: 240px; /* Max-Höhe vor Scroll (JS maxH) */
        overflow-y: auto;
        resize: none;
        padding: 0.35rem 0.9rem 0.30rem 0.75rem; /* Innenabstand */
        font-size: 20px; /* Schriftgröße Eingabe */
        line-height: 1.3; /* Zeilenhöhe */
        background: transparent;
        color: #fff;
        border: none;
        outline: none;
        box-sizing: border-box;
        scrollbar-color: rgba(255,255,255,0.35) transparent;
        scrollbar-width: thin;
    }

    .chat-input-wrapper:focus-within {
        box-shadow: 0 0 0 2px rgba(37,140,251,0.35); /* Fokus-Rand */
        border-color: #258cfb;
    }

    /* Scrollbar Styling */
    textarea.chat-input::-webkit-scrollbar {
        width: 8px;
    }
    /* Breite Scrollbar */
    textarea.chat-input::-webkit-scrollbar-track {
        background: transparent;
        margin: 6px 0;
    }

    textarea.chat-input::-webkit-scrollbar-thumb {
        background: rgba(255,255,255,0.30);
        border-radius: 8px;
    }

        textarea.chat-input::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.40);
        }

    textarea.chat-input::-webkit-scrollbar-button {
        height: 0;
        display: none;
    }
</style>